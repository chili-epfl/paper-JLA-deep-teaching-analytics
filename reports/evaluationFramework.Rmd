---
title: "Basic framework to evaluate/compare models on the Teacher Activity Detection dataset"
date: "`r Sys.Date()`"
output:
  rmdformats::html_clean:
    highlight: kate
---


```{r knitr_init, echo=FALSE, cache=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="75")
opts_chunk$set(echo=FALSE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

# Loading and splitting the data

```{r}
datafile <- '../data/processed/completeDataset-NOVIDEO.csv.gz'
fulldata <- read.csv(gzfile(datafile))

fulldata <- fulldata[ order(fulldata[,3], fulldata[,4]), ]
head(fulldata[,1:6])
table(fulldata$session, fulldata$Activity.win, useNA = "always")
table(fulldata$session, fulldata$Social.win, useNA = "always")

# We only look for predicting 4 states of activity and 3 of social, the rest (incl.NA) we bunch in 'Other'
fulldata$Activity.clean <- ifelse(is.na(as.character(fulldata$Activity.win)) | 
                                      as.character(fulldata$Activity.win)=='OFF' |
                                      as.character(fulldata$Activity.win)=='TDT' |
                                      as.character(fulldata$Activity.win)=='TEC',
                                  'Other',as.character(fulldata$Activity.win))

fulldata$Social.clean <- ifelse(is.na(as.character(fulldata$Social.win)),
                                  'Other',as.character(fulldata$Social.win))

names(fulldata)[6562:6563] <- c('Activity','Social')
fulldata <- fulldata[,-c(1,2,5,6)]
fulldata$Activity <- factor(fulldata$Activity)
fulldata$Social <- factor(fulldata$Social)
```

## Basic split

... one session per teacher, with variety of states of Activity and Social

```{r}

# We build the clean datasets to train models
train <- fulldata[fulldata$session=='case2-day3-session1-teacher2' | fulldata$session=='case1-day1-session1-teacher1',]
test <- fulldata[fulldata$session!='case2-day3-session1-teacher2' & fulldata$session!='case1-day1-session1-teacher1',]
```

# A basic benchmark: Random Forest

Since RF performed quite well in most cases for our LAK paper dataset, let's try it on the whole dataset and see what comes out, as a basis for predictions

## Teacher activity

```{r}
library(caret)
# Setup the seeds and training
set.seed(123)
seeds <- vector(mode = "list", length = 51)
for(i in 1:50) seeds[[i]] <- sample.int(1000, 22)
seeds[[51]] <- sample.int(1000, 1)
ctrl <- trainControl(method = "repeatedcv",
                     repeats = 5,
                     seeds = seeds)
set.seed(1)
fitA <- train(Activity ~ ., data=train[,-c(1,2,6559)], 
             method="rf", ntree=2000, trControl=ctrl,
             prox=TRUE, allowParallel=TRUE)
summary(fitA)
test$Activity.pred = predict(fitA, test, "raw")
confusionMatrix(test$Activity.pred, test$Activity)
varImp(fitA, scale=FALSE)

```

## Social plane

```{r}
set.seed(1)
fitS <- train(Social ~ ., data=train[,-c(1,2,6558)], 
             method="rf", ntree=2000, trControl=ctrl,
             prox=TRUE, allowParallel=TRUE)
summary(fitS)
test$Activity.pred = predict(fitS, test, "raw")
confusionMatrix(test$Activity.pred, test$Activity)
varImp(fitS, scale=FALSE)

```